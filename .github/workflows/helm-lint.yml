name: Helm Chart CI

on:
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'src/**'
      - '.github/workflows/helm-lint.yml'
  push:
    branches:
      - main
      - master
    paths:
      - 'src/**'

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: Run chart-testing (lint)
        run: ct lint --target-branch ${{ github.event.repository.default_branch }} --charts src/va-scanner

      - name: Helm Lint
        run: |
          helm lint src/va-scanner

      - name: Helm Template
        run: |
          helm template va-scanner src/va-scanner --values src/va-scanner/values-example.yaml

      - name: Create kind cluster
        uses: helm/kind-action@v1.10.0

      - name: Run chart-testing (install)
        run: |
          # Create test values with dummy credentials
          cat > test-values.yaml <<EOF
          namespace:
            create: true
            name: va-scanner-test
          
          gdp:
            host: "test.example.com"
            apiKey: "dGVzdC1hcGkta2V5"
            agentName: "test-agent"
            certBase64: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURFekNDQWZ1Z0F3SUJBZ0lVRXhhbXBsZUNlcnRpZmljYXRlRm9yVGVzdGluZzB3RFFZSktvWklodmNOQVFFTApCUUF3R1RFWE1CVUdBMVVFQXd3T2RHVnpkQzVsZUdGdGNHeGxMbU52YlRBZUZ3MHlOREF4TURFd01EQXdNREJhCkZ3MHlOVEF4TURFd01EQXdNREJhTUJreEZ6QVZCZ05WQkFNTURuUmxjM1F1WlhoaGJYQnNaUzVqYjIwd2dnRWkKTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFEVGVzdENlcnRpZmljYXRlRGF0YUhlcmUwCk1JSURFekNDQWZ1Z0F3SUJBZ0lVRXhhbXBsZUNlcnRpZmljYXRlRm9yVGVzdGluZzB3RFFZSktvWklodmNOQVFFTApCUUF3R1RFWE1CVUdBMVVFQXd3T2RHVnpkQzVsZUdGdGNHeGxMbU52YlRBZUZ3MHlOREF4TURFd01EQXdNREJhCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"
          
          registry:
            username: "test"
            password: "test-password"
            email: "test@example.com"
          
          autoscaling:
            enabled: false
          
          replicaCount: 1
          EOF
          
          # Install chart with test values
          helm install va-scanner-test src/va-scanner -f test-values.yaml --wait --timeout 5m
          
          # Check deployment
          kubectl get all -n va-scanner-test
          
          # Cleanup
          helm uninstall va-scanner-test

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'src/va-scanner'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  validate-yaml:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: src/va-scanner
          config_data: |
            extends: default
            rules:
              line-length:
                max: 120
                level: warning
              indentation:
                spaces: 2
              document-start: disable
              truthy:
                allowed-values: ['true', 'false', 'yes', 'no']

  check-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f "README.md" ]; then
            echo "ERROR: README.md not found"
            exit 1
          fi
          echo "✓ README.md exists"

      - name: Check Chart.yaml
        run: |
          if [ ! -f "src/va-scanner/Chart.yaml" ]; then
            echo "ERROR: Chart.yaml not found"
            exit 1
          fi
          echo "✓ Chart.yaml exists"

      - name: Validate Chart.yaml
        run: |
          helm show chart src/va-scanner

      - name: Check values.yaml
        run: |
          if [ ! -f "src/va-scanner/values.yaml" ]; then
            echo "ERROR: values.yaml not found"
            exit 1
          fi
          echo "✓ values.yaml exists"