name: Release Helm Chart

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Update Chart version
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          sed -i "s/^version:.*/version: $VERSION/" src/va-scanner/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"$VERSION\"/" src/va-scanner/Chart.yaml

      - name: Package Helm chart
        run: |
          helm package src/va-scanner -d releases/
          helm repo index releases/ --url https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.tag }}

      - name: Create Release Notes
        id: release_notes
        run: |
          cat > release_notes.md <<EOF
          # Guardium VA Scanner Helm Chart ${{ steps.get_version.outputs.tag }}
          
          ## ðŸ“¦ Installation
          
          \`\`\`bash
          # Add Helm repository
          helm repo add guardium https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.tag }}
          helm repo update
          
          # Install the chart
          helm install va-scanner guardium/va-scanner -f my-values.yaml -n va-scanner --create-namespace
          \`\`\`
          
          ## ðŸ“¥ Direct Download
          
          \`\`\`bash
          # Download packaged chart
          curl -LO https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.tag }}/va-scanner-${{ steps.get_version.outputs.version }}.tgz
          
          # Install from local file
          helm install va-scanner ./va-scanner-${{ steps.get_version.outputs.version }}.tgz -f my-values.yaml -n va-scanner --create-namespace
          \`\`\`
          
          ## ðŸ”§ What's Included
          
          - Complete Helm chart for Guardium VA Scanner
          - Production-ready templates with HPA, secrets, and security configs
          - Comprehensive documentation
          - Example values files
          - Deployment scripts
          
          ## ðŸ“š Documentation
          
          See [README.md](https://github.com/${{ github.repository }}/blob/${{ steps.get_version.outputs.tag }}/README.md) for complete setup instructions.
          
          ## âœ… Validation
          
          This release has been validated with:
          - Helm lint
          - Chart testing
          - Security scanning (Trivy)
          - YAML validation
          
          ## ðŸ”’ Security
          
          - Non-root container execution
          - Secret management for credentials
          - RBAC support
          - Network policies ready
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: Release ${{ steps.get_version.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            releases/va-scanner-${{ steps.get_version.outputs.version }}.tgz
            releases/index.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Note: Version changes are NOT pushed back to main automatically
      # This prevents auto-merging PRs. Update Chart.yaml manually before tagging.

  publish-ghcr:
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Package and push to GHCR
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          helm package src/va-scanner
          helm push va-scanner-${VERSION}.tgz oci://ghcr.io/${{ github.repository_owner }}